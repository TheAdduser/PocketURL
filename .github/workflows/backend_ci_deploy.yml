name: Backend Deploy DEV

on:
  push:
    branches:
      - dev # Uruchamia się tylko przy pushu do gałęzi 'dev'
  pull_request:
    branches:
      - dev # Uruchamia się przy Pull Requestach do gałęzi 'dev'

jobs:
  # =======================================================
  # JOB 1: TESTY (Continuous Integration)
  # Weryfikuje kod Pythona przed rozpoczęciem deploymentu.
  # =======================================================
  ci_tests:
    name: Run Python CI Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Konfiguracja Pythona ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          # Monitorowanie pliku zależności, aby przyspieszyć instalację
          cache-dependency-path: backend/requirements.txt 
          
      - name: Install dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt
        
      # --- Krok Testowy ---
      - name: Run Backend Tests (Pytest)
        working-directory: ./backend
        run: python -m pytest 
        
  # =======================================================
  # JOB 2: DEPLOY (Trigger Render Hook)
  # Uruchamiany tylko na gałęzi 'dev' po sukcesie testów.
  # =======================================================
  deploy:
    name: Trigger Render Deployment
    runs-on: ubuntu-latest
    needs: ci_tests # Wymaga udanego przejścia testów z Joba 1
    environment: dev # Przypisanie do środowiska 'dev'
    
    steps:
      # --- Wywołanie Wdrożenia Render.com ---
      - name: Setup Node.js (do curl)
        # Instalujemy Node.js, ponieważ akcja 'curl' może być łatwiej dostępna
        # przy użyciu tego runnera Node.
        uses: actions/setup-node@v4 
        with:
            node-version: '20' 
            
      - name: Send Deploy Request to Render
        # Używamy Hooka, aby poinformować Render, że ma pobrać kod z gałęzi 'dev' i zdeployować.
        # Wartość jest pobierana z GitHub Secret.
        run: curl -X POST ${{ secrets.BACKEND_RENDER_HOOK }}
        env:
          BACKEND_RENDER_HOOK: ${{ secrets.BACKEND_RENDER_HOOK }}